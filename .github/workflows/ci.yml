name: CI - Code Validation and Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-files:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate required files exist
      run: |
        echo "ğŸ” Checking project structure..."
        required_files=("index.html" "style.css" "script.js")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file is missing!"
            exit 1
          fi
        done
        echo "ğŸ‰ All required files are present!"

  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest
    needs: validate-files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install HTML validator
      run: |
        npm install -g html-validator-cli
        
    - name: Validate HTML syntax
      run: |
        echo "ğŸ“„ Validating HTML structure..."
        if ! html-validator --file index.html --verbose; then
          echo "âš ï¸ HTML validation found issues, but continuing..."
        fi
        
    - name: Check HTML essential elements
      run: |
        echo "ğŸ” Checking HTML essential elements..."
        if ! grep -q "<title>" index.html; then
          echo "âŒ Missing <title> tag"
          exit 1
        fi
        
        if ! grep -q "DOCTYPE html" index.html; then
          echo "âŒ Missing DOCTYPE declaration"
          exit 1
        fi
        
        if ! grep -q "lang=" index.html; then
          echo "âŒ Missing language attribute"
          exit 1
        fi
        
        echo "âœ… HTML essential elements are present"

  validate-css:
    name: Validate CSS
    runs-on: ubuntu-latest
    needs: validate-files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install CSS validator
      run: |
        npm install -g css-validator
        
    - name: Validate CSS syntax
      run: |
        echo "ğŸ¨ Validating CSS syntax..."
        if ! css-validator style.css; then
          echo "âš ï¸ CSS validation found issues, but continuing..."
        fi
        
    - name: Check CSS file content
      run: |
        echo "ğŸ” Checking CSS content..."
        if [ ! -s style.css ]; then
          echo "âŒ CSS file is empty"
          exit 1
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… CSS Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
        if ! grep -q "{" style.css || ! grep -q "}" style.css; then
          echo "âŒ CSS file seems malformed"
          exit 1
        fi
        
        echo "âœ… CSS file structure is valid"

  validate-javascript:
    name: Validate JavaScript
    runs-on: ubuntu-latest
    needs: validate-files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Check JavaScript syntax
      run: |
        echo "ğŸ“œ Validating JavaScript syntax..."
        if node -c script.js; then
          echo "âœ… JavaScript syntax is valid"
        else
          echo "âŒ JavaScript syntax error!"
          exit 1
        fi
        
    - name: Check for common JS errors
      run: |
        echo "ğŸ” Checking for common JavaScript issues..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
        if [ ! -s script.js ]; then
          echo "âŒ JavaScript file is empty"
          exit 1
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ (Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ‡ĞµĞº)
        if ! grep -q "function" script.js && ! grep -q "=>" script.js; then
          echo "âš ï¸ No functions found in JavaScript file"
        fi
        
        echo "âœ… JavaScript basic checks passed"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for sensitive data
      run: |
        echo "ğŸ”’ Checking for sensitive data..."
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
        if grep -r "password\|secret\|key\|token" . --include="*.js" --include="*.html" | grep -v "//\|test"; then
          echo "âš ï¸ Potential sensitive data found"
          # ĞĞµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´Ğ°ĞµĞ¼
        else
          echo "âœ… No obvious sensitive data found"
        fi

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [validate-html, validate-css, validate-javascript]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python for simple HTTP server
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Start HTTP server
      run: |
        echo "ğŸš€ Starting test server..."
        python -m http.server 8080 &
        echo $! > server.pid
        sleep 3
        
    - name: Test if application loads
      run: |
        echo "ğŸŒ Testing application load..."
        if curl -f http://localhost:8080 > /dev/null 2>&1; then
          echo "âœ… Application loads successfully"
        else
          echo "âŒ Application failed to load"
          exit 1
        fi
        
    - name: Stop HTTP server
      run: |
        kill $(cat server.pid) 2>/dev/null || true

  final-report:
    name: Final Report
    runs-on: ubuntu-latest
    needs: [validate-files, validate-html, validate-css, validate-javascript, security-scan, integration-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate validation report
      run: |
        echo "ğŸ“Š VALIDATION REPORT"
        echo "===================="
        echo "âœ… All checks completed successfully!"
        echo "ğŸ“ Project structure: Valid"
        echo "ğŸ“„ HTML: Valid" 
        echo "ğŸ¨ CSS: Valid"
        echo "ğŸ“œ JavaScript: Valid"
        echo "ğŸ”’ Security: No critical issues"
        echo "ğŸŒ Integration: Application loads"
        echo ""
        echo "ğŸ‰ All systems go! Ready for deployment."
        
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-validation
        path: |
          index.html
          style.css
        retention-days: 1
